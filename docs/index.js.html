<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file Please, A Promise Helper Library.
 * @version 0.0.1
 * @author Adam Mill
 * @copyright Copyright 2016 Adam Mill
 * @license Apache-2.0
 */
'use strict';

/* Imports. */
const pkg = require('./package.json');

/* Constants. */
const version = pkg.version;

/* Symbols. */
const STOP = { '&lt;sym>': 'stop' };

/**
 * Is value a function?
 * @private
 * @param  {any}  value Type to check.
 * @return {boolean}       True if function, false otherwise.
 */
function isFunction(value) {
	return typeof value === 'function';
}

/**
 * Is the value a promise?
 * @param  {any}  value The value to check.
 * @return {boolean}       True if promise, false if not.
 */
function isPromise(value) {
	return !!(
			value instanceof Promise	// Instance check.
			|| ( 											// Ducktype.
				value
				&amp;&amp; typeof value === 'object'
				&amp;&amp; typeof value.then === 'function'
				&amp;&amp; typeof value.catch === 'function'
			)
		);
}

/**
 * Return a function that returns the next item in a collection each call.
 * @param  {Object|Array} collection The collection to iterate over.
 * @return {Object|undefined}            Object containing next item or undefined if done.
 */
function iterable(collection) {
	let idx = 0;
	let keys;
	let length;
	if(Array.isArray(collection)) {
		length = collection.length;
	} else if (collection &amp;&amp; typeof collection === 'object') {
		keys = Object.keys(collection);
		length = keys.length;
	} else {
		const msg = (''+collection).substring(0,20);
		throw new Error(`Can not iterate over "${msg}" (${typeof collection})`);
	}
	return function iterable_() {
		if(idx >= length) {
			return undefined;
		}
		const key =  keys ? keys[idx] : idx;
		const value = keys ? collection[key] : collection[idx];
		return {
			// Collection.
			length,
			collection,
			// Item.
			key, value,
			idx: idx++
		};
	}
}

/**
 * Execute action while condition is not met.
 * Like a do { } while() loop. The condition is evaluated after the loop.
 * @function do
 * @param  {any} initial   The initial value, if Function call and use value.
 * @param  {function} condition Condition test, if returns false stop looping.
 * @param  {function} action    Action to execute. Results passed to condition and next aciton.
 * @return {Promise}           Resolves when condition met.
 */
function _do(initial, condition, action) {
	if(arguments.length === 1) {
		// Supplying the action function.
		action = initial;
		condition = (value, idx) => {
			// NOTE: Must skip first condition check or it will stop immediatly.
			return !!(idx === 0 ? true : value)
		};
		initial = undefined;
	} else if(arguments.length === 2) {
		// Supplying initial value and action functions.
		action = condition;
		condition = (value, idx) => { return !!value };
	} else {
		const conditionOriginal = condition;
		condition = (value, idx) => {
			if(idx === 0) {
				return true;
			}
			// The first condition check is skipped so adjust the index.
			return conditionOriginal(value, idx-1)
		};
	}
	return _while(initial, condition, action);
}

/**
 * Execute action while condition is not met.
 * Like a while() { } loop. The condition is evaluated before the loop.
 * @function while
 * @param  {any} initial   The initial value, if Function call and use value.
 * @param  {function} condition Condition test, if returns false stop looping.
 * @param  {function} action    Action to execute. Results passed to condition and next aciton.
 * @return {Promise}           Resolves when condition met.
 */
function _while(initial, condition, action) {
	if(arguments.length === 1) {
		// Supplying the action function.
		action = initial;
		condition = (value, idx) => {
			// NOTE: Must skip first condition check or it will stop immediatly.
			return !!(idx === 0 ? true : value)
		};
		initial = undefined;
	} else if(arguments.length === 2) {
		// Supplying initial value and action functions.
		action = condition;
		condition = (value, idx) => { return !!value };
	}
	function tick(value, idx, resolve, reject) {
		Promise.resolve(condition(value, idx))
			.then(result => {
				if(result) {
					Promise.resolve(action(value, idx))
						.then((result) => {
							global.setImmediate(() => {
								tick(result, idx+1, resolve, reject);
							});
							return null;
						}).catch(reject);
				} else {
					resolve(value);
				}
				return null;
			}).catch(reject);
	};
	return new Promise((resolve, reject) => {
		Promise.resolve(isFunction(initial) ? initial() : initial)
			.then(value => {
				tick(value, 0, resolve, reject);
				return null;
			}).catch(reject);
		return null;
	});
};

/**
 * The find method returns a value in the collection, if an element in
 * the collection satisfies the provided testing function. Otherwise undefined is returned.
 * Similar to Array.find.
 * REF: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/find
 * @param  {Array|Object} collection      Collection to search.
 * @param  {function} condition Condition test function. Should return true if match, otherwise false.
 * @return {Promise}           Resolves when found or end of collection is reached.
 */
function find(collection, condition) {
	const next = iterable(collection);
	return _do(undefined, item => {
			if(item === STOP) {
				return false;
			}
			return Promise.resolve(condition(item.value, item.key))
				.then(result => {
					return !result;
				});
		}, () => {
			const item = next();
			if(item === undefined) {
				return STOP;
			}
			return Promise.resolve(item.value) // Resolve this, it may be a promise.
				.then(() => { return item; });
		}).then(item => {
			return item === STOP ? undefined : item.value;
		});
}

/**
 * The forEach() method executes a provided function once per array element.
 * Similar to Array.forEach.
 * REF: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/find
 * @param  {Array|Object} collection      Collection to loop over.
 * @param  {function} action    Action to execute.
 * @return {Promise}           Resolves when end of collection is reached.
 */
function forEach(collection, action) {
	const next = iterable(collection);
	return _while(undefined, item => {
			return item !== STOP;
		}, () => {
			const item = next();
			if(item === undefined) {
				return STOP;
			}
			return Promise.resolve(action(item.value, item.key));
		}).then(() => {
			return undefined;
		});
}

/**
 * The callEach() calls each function in an array and resolves any values
 * returned. Items that are not functions are resolved.
 * @param  {Array|Object} collection      Collection to loop over.
 * @return {Promise}           Resolves when end of collection is reached.
 * Resolves to an array containing the results of each resolved item.
 */
function callEach(collection) {
	const next = iterable(collection);
	const results = [ ];
	return _while(undefined, item => {
			return item !== STOP;
		}, () => {
			const item = next();
			if(item === undefined) {
				return STOP;
			}
			const value = isFunction(item.value)
				? item.value()
				: item.value;
			return Promise.resolve(value)
				.then(value => {
					results.push(value);
					return value;
				});
		}).then(() => {
			return results;
		})
}

/* Exports. */
module.exports = {
	// Library.
	version,
	// Iteration.
	iterable,
	// Is-type helpers.
	isPromise,
	// Looping.
	forEach,
	callEach,
	while: _while,
	do: _do,
	// Finding.
	find
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#callEach">callEach</a></li><li><a href="global.html#do">do</a></li><li><a href="global.html#find">find</a></li><li><a href="global.html#forEach">forEach</a></li><li><a href="global.html#isPromise">isPromise</a></li><li><a href="global.html#iterable">iterable</a></li><li><a href="global.html#while">while</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.1</a> on Mon Sep 12 2016 17:56:48 GMT-0400 (EDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
